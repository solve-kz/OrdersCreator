<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

	<!-- === ПРОДУКТ === -->
	<Product Id="*"
			 Name="Складской терминал (OrderCreator)"
			 Language="1049"
			 Version="1.0.0.0"
			 Manufacturer="ИП Приходько П. С."
			 UpgradeCode="fd8013a8-3178-4cfe-96cf-8f0feb1b38de"
			 Codepage="1251">

		<Package InstallerVersion="300"
				 Compressed="yes"
				 InstallScope="perMachine" />

		<!-- Запрет даунгрейда -->
		<MajorUpgrade DowngradeErrorMessage="Более новая версия [ProductName] уже установлена." />
		<MediaTemplate />

		<!-- Одна фича, включающая все компоненты -->
		<Feature Id="ProductFeature"
				 Title="OrderCreator"
				 Level="1">
			<ComponentGroupRef Id="ProductComponents" />
		</Feature>
	</Product>

	<!-- === ДЕРЕВО ПАПОК === -->
	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">

			<!-- Program Files\OrderCreator -->
			<Directory Id="ProgramFilesFolder">
				<Directory Id="INSTALLFOLDER" Name="OrderCreator" />
			</Directory>

			<!-- Рабочий стол текущего пользователя (для ярлыка) -->
			<Directory Id="DesktopFolder" Name="Desktop" />

		</Directory>
	</Fragment>

	<!-- === КОМПОНЕНТЫ (EXE, ЯРЛЫК, БАЗА) === -->
	<Fragment>

		<!-- Группа компонентов, на которую ссылается Feature -->
		<ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">

			<!-- 1. Основной EXE + ярлык на рабочем столе -->
			<Component Id="cmp_MainExe"
					   Guid="FDAF3600-6651-49D8-9B35-3CECB9CF199A">

				<!-- EXE из выходной папки проекта UI (есть Project Reference на OrdersCreator.UI) -->
				<File Id="fil_MainExe"
					  Source="$(var.OrdersCreator.UI.TargetDir)OrdersCreator.UI.exe" />

				<!-- Ярлык на рабочем столе -->
				<Shortcut Id="sc_OrderCreatorDesktop"
						  Directory="DesktopFolder"
						  Name="Складской терминал"
						  WorkingDirectory="INSTALLFOLDER"
						  Target="[INSTALLFOLDER]OrdersCreator.UI.exe"
						  Icon="AppIcon"
						  IconIndex="0" />

				<!-- RegistryValue как KeyPath: по нему MSI отслеживает компонент -->
				<RegistryValue Id="reg_DesktopShortcut"
							   Root="HKCU"
							   Key="Software\OrderCreator"
							   Name="Installed"
							   Type="integer"
							   Value="1"
							   KeyPath="yes" />
			</Component>

			<!-- 2. Предзаполненная база данных.
             Permanent + NeverOverwrite = не удаляем и не перезаписываем при обновлениях -->
			<Component Id="cmp_InitialDatabase"
					   Guid="4D5D65E9-0C8C-4C5C-9F7A-5C4BDF3E2F11"
					   Permanent="yes"
					   NeverOverwrite="yes">
				<File Id="fil_InitialDb"
					  Source="$(var.OrdersCreator.UI.ProjectDir)InstallerContent\Data\OrderCreator.db"
					  Name="OrderCreator.db"
					  KeyPath="yes" />
			</Component>

		</ComponentGroup>

	</Fragment>

	<!-- === ИКОНКА ПРИЛОЖЕНИЯ ДЛЯ ЯРЛЫКА === -->
	<Fragment>
		<Icon Id="AppIcon"
			  SourceFile="$(var.OrdersCreator.UI.ProjectDir)Resources\icon-barcode-scanner.ico" />
	</Fragment>

</Wix>
